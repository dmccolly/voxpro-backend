<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0" />
  <title>VoxPro Manager</title>
  <style>
    :root{
      --bg-dark:#121212;--bg-panel:#1e1e1e;--bg-input:#242424;--text:#fff;--muted:#b0b0b0;--accent:#00ff88;--blue:#0066ff;--red:#ff4444;--border:#333;--shadow:0 8px 30px rgba(0,0,0,.35)
    }
    *{box-sizing:border-box;margin:0;padding:0}
    body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,Inter,Arial,sans-serif;background:var(--bg-dark);color:var(--text);min-height:100vh;padding:24px}
    .container{max-width:1400px;margin:0 auto;display:grid;grid-template-columns:1fr 1fr;gap:28px}
    .panel{background:var(--bg-panel);border:1px solid var(--border);border-radius:14px;box-shadow:var(--shadow);padding:22px}
    .panel-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:18px;padding-bottom:12px;border-bottom:2px solid var(--accent)}
    .panel-title{font-size:22px;font-weight:800;color:var(--accent)}
    .status{padding:6px 12px;border-radius:999px;font-size:12px;font-weight:800;color:#111;background:var(--accent)}
    .status.bad{background:var(--red);color:#fff}
    .grid-keys{display:grid;grid-template-columns:repeat(2,1fr);gap:14px;margin-bottom:18px}
    .key{background:#444;background:linear-gradient(145deg,#444,#262626);border:2px solid var(--border);border-radius:12px;min-height:86px;padding:18px;font-size:18px;font-weight:800;color:#fff;cursor:pointer;transition:all .2s ease;display:flex;align-items:center;justify-content:center}
    .key:hover{border-color:var(--accent);box-shadow:0 0 18px rgba(0,255,136,.35)}
    .key.assigned{background:linear-gradient(145deg,var(--blue),#003fb6);border-color:var(--blue)}
    .key.playing{background:linear-gradient(145deg,var(--accent),#05c86e);border-color:var(--accent);box-shadow:0 0 24px rgba(0,255,136,.6)}
    .grid-keys .key:nth-child(5){grid-column:1/-1;justify-self:center;width:220px}
    .stop{background:#ff2d2d;background:linear-gradient(145deg,var(--red),#cc0000);border:2px solid var(--red);border-radius:12px;color:#fff;padding:12px 24px;font-weight:800;cursor:pointer}
    .section-title{font-size:16px;font-weight:800;color:var(--accent);margin:18px 0 10px}
    .list{background:var(--bg-input);border:1px solid var(--border);border-radius:10px;max-height:320px;overflow:auto}
    .row{display:flex;gap:12px;align-items:center;padding:12px;border-bottom:1px solid var(--border);cursor:pointer}
    .row:last-child{border-bottom:none}
    .row:hover{background:rgba(0,255,136,.07)}
    .row.selected{background:rgba(0,255,136,.14);border-left:4px solid var(--accent)}
    .thumb{width:42px;height:42px;border-radius:6px;background:#0b0b0b;display:flex;align-items:center;justify-content:center;font-size:14px;color:#bbb;overflow:hidden;position:relative}
    .thumb img,.thumb video{width:100%;height:100%;object-fit:cover;border-radius:6px;position:absolute;top:0;left:0}
    .thumb .icon{position:relative;z-index:2;font-size:18px}
    .info{flex:1}
    .title{font-weight:700}
    .meta{font-size:12px;color:var(--muted);margin-top:2px}
    .label{display:block;margin:12px 0 6px;color:var(--muted);font-size:13px;font-weight:700}
    .input,.select,.textarea{width:100%;background:var(--bg-input);border:1px solid var(--border);border-radius:8px;color:#fff;padding:12px;font-size:14px}
    .textarea{min-height:96px;resize:vertical}
    .btn{background:var(--accent);border:none;color:#111;padding:12px 18px;border-radius:8px;font-weight:800;cursor:pointer}
    .btn:hover{filter:brightness(.95)}
    .btn-danger{background:var(--red);color:#fff}
    .alert{margin-bottom:12px;padding:12px;border-radius:10px;border:1px solid;display:none}
    .alert.error{display:block;background:rgba(255,68,68,.1);border-color:#ff5f5f;color:#ff7c7c}
    .alert.success{display:block;background:rgba(0,255,136,.1);border-color:#06d97d;color:#00ff88}
    .current{background:#0c0c0c;border:1px solid var(--border);border-radius:10px;padding:14px;margin-top:12px}
    .current .h{color:var(--accent);font-weight:800;margin-bottom:6px}
    .modal{display:none;position:fixed;inset:0;background:rgba(0,0,0,.78);z-index:9999}
    .sheet{position:fixed;bottom:20px;left:20px;width:520px;height:520px;background:var(--bg-panel);border:2px solid var(--accent);border-radius:12px;box-shadow:0 10px 40px rgba(0,0,0,.5);display:flex;flex-direction:column;overflow:hidden}
    .sheet-h{background:var(--accent);color:#111;padding:12px 14px;font-weight:900;display:flex;justify-content:space-between;align-items:center}
    .sheet-x{background:none;border:none;font-size:22px;font-weight:900;color:#111;cursor:pointer}
    .sheet-body{padding:14px;display:flex;flex-direction:column;gap:12px;height:100%}
    .media{flex:1;background:#0e0e0e;border-radius:8px;display:flex;align-items:center;justify-content:center;overflow:hidden}
    .desc{background:rgba(0,0,0,.28);border:1px solid var(--border);border-radius:8px;padding:12px;color:#b0b0b0;max-height:150px;overflow:auto}
    @media(max-width:980px){.container{grid-template-columns:1fr}}
  </style>
</head>
<body>
  <div class="container">
    <section class="panel">
      <div class="panel-header">
        <div class="panel-title">VoxPro Media Player</div>
        <div class="status" id="connectionStatus">Connectingâ€¦</div>
      </div>
      <div class="grid-keys" id="keyGrid">
        <button class="key" data-key="1">KEY 1</button>
        <button class="key" data-key="2">KEY 2</button>
        <button class="key" data-key="3">KEY 3</button>
        <button class="key" data-key="4">KEY 4</button>
        <button class="key" data-key="5">KEY 5</button>
      </div>
      <button class="stop" id="stopButton">STOP</button>
      <div class="section-title">Current Key Assignments</div>
      <div class="list" id="assignmentsList">
        <div class="row"><div class="info">Loading assignmentsâ€¦</div></div>
      </div>
      <div class="current" id="currentInfo" style="display:none;">
        <div class="h" id="currentTitle">Now Playing</div>
        <div class="meta" id="currentMeta"></div>
      </div>
    </section>

    <section class="panel">
      <div class="panel-header">
        <div class="panel-title">VoxPro Manager</div>
        <div style="font-size:12px;color:#b0b0b0">Search Webflow + Xano (with Xano fallback)</div>
      </div>
      <div id="alert" class="alert"></div>
      <label class="label" for="searchInput">Search Media (title, description, station, tags)</label>
      <input class="input" id="searchInput" placeholder="Type to searchâ€¦ or leave empty for recent" />
      <div class="list" id="mediaBrowser" style="margin-top:10px">
        <div class="row"><div class="info">Waiting for searchâ€¦</div></div>
      </div>
      <div id="selectedMedia" class="meta" style="margin-top:8px;"></div>
      <label class="label">Select Key Slot</label>
      <select class="select" id="keySelect">
        <option value="">Choose a keyâ€¦</option>
        <option value="1">Key 1</option>
        <option value="2">Key 2</option>
        <option value="3">Key 3</option>
        <option value="4">Key 4</option>
        <option value="5">Key 5</option>
      </select>
      <label class="label" for="titleInput">Title</label>
      <input class="input" id="titleInput" placeholder="Title" list="titleOptions" readonly />
      <datalist id="titleOptions"></datalist>
      <label class="label" for="descriptionInput">Description</label>
      <textarea class="textarea" id="descriptionInput" placeholder="Description" readonly></textarea>
      <label class="label" for="stationInput">Station</label>
      <input class="input" id="stationInput" placeholder="Station" list="stationOptions" readonly />
      <datalist id="stationOptions"></datalist>
      <label class="label" for="tagsInput">Tags</label>
      <input class="input" id="tagsInput" placeholder="Comma-separated" readonly />
      <label class="label" for="submittedByInput">Submitted By</label>
      <input class="input" id="submittedByInput" placeholder="Name or initials" readonly />
      <div style="margin-top:14px;display:flex;gap:10px">
        <button class="btn" id="assignButton" style="flex:1">Assign / Update Key</button>
      </div>
      <div class="section-title">Current Assignments</div>
      <div class="list" id="assignmentsListManager">
        <div class="row"><div class="info">Loadingâ€¦</div></div>
      </div>
    </section>
  </div>

  <div class="modal" id="mediaModal">
    <div class="sheet">
      <div class="sheet-h">
        <span id="modalTitle">Player</span>
        <button class="sheet-x" id="modalClose">Ã—</button>
      </div>
      <div class="sheet-body">
        <div class="media" id="mediaPlayer"></div>
        <div class="desc" id="mediaDescription"></div>
      </div>
    </div>
  </div>

  <script>
    // ===== Configuration =====
    const SEARCH_API_PRIMARY = 'https://majestic-beijinho-cd3d75.netlify.app/.netlify/functions/search-media';
    const SEARCH_API_SECONDARY = '';
    const XANO_PROXY_BASE = 'https://majestic-beijinho-cd3d75.netlify.app/.netlify/functions/xano-proxy';
    const ASSIGNMENTS_REFRESH_MS = 30000;

    // ===== State =====
    let unifiedResults = [];
    let assignments = [];
    let selectedUnified = null;
    let playing = null; // { key:number, asset: { ... } }
    let connGood = false;
    let searchEndpointChosen = null;
    let activeMediaEl = null; // <audio>/<video> reference if playing

    // ===== DOM =====
    const keyButtons = [...document.querySelectorAll('.key[data-key]')];
    const stopButton = document.getElementById('stopButton');
    const assignmentsList = document.getElementById('assignmentsList');
    const assignmentsListManager = document.getElementById('assignmentsListManager');
    const connectionStatus = document.getElementById('connectionStatus');
    const searchInput = document.getElementById('searchInput');
    const mediaBrowser = document.getElementById('mediaBrowser');
    const selectedMedia = document.getElementById('selectedMedia');
    const keySelect = document.getElementById('keySelect');
    const titleInput = document.getElementById('titleInput');
    const descriptionInput = document.getElementById('descriptionInput');
    const stationInput = document.getElementById('stationInput');
    const tagsInput = document.getElementById('tagsInput');
    const submittedByInput = document.getElementById('submittedByInput');
    const assignButton = document.getElementById('assignButton');
    const alertBox = document.getElementById('alert');
    const currentInfo = document.getElementById('currentInfo');
    const currentTitle = document.getElementById('currentTitle');
    const currentMeta = document.getElementById('currentMeta');
    const mediaModal = document.getElementById('mediaModal');
    const modalClose = document.getElementById('modalClose');
    const modalTitle = document.getElementById('modalTitle');
    const mediaPlayer = document.getElementById('mediaPlayer');
    const mediaDescription = document.getElementById('mediaDescription');
    const titleOptions = document.getElementById('titleOptions');
    const stationOptions = document.getElementById('stationOptions');

    // ===== Helpers =====
    const esc = (s)=> (s||'').toString().replace(/[&<>\"']/g, c=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;' }[c]));

    function createThumbnail(item){
      const mediaUrl = item.media_url || item.database_url || item.file_url || item.url || '';
      const thumbnailUrl = item.thumbnail || '';
      const fileType = (item.file_type || '').toLowerCase();
      let html = '<div class="icon">'+ getFileIcon(fileType) +'</div>';
      if(fileType.includes('image') && mediaUrl){
        html = '<img src="'+ esc(mediaUrl) +'" onload="this.style.opacity=1" onerror="this.style.display=\'none\'" style="opacity:0;transition:opacity .3s" />'+ html;
      } else if(fileType.includes('video') && mediaUrl){
        html = '<video muted preload="metadata" onloadeddata="this.style.opacity=1" onerror="this.style.display=\'none\'" style="opacity:0;transition:opacity .3s"><source src="'+ esc(mediaUrl) +'#t=1"></video>'+ html;
      } else if(thumbnailUrl && !thumbnailUrl.includes('placeholder')){
        html = '<img src="'+ esc(thumbnailUrl) +'" onload="this.style.opacity=1" onerror="this.style.display=\'none\'" style="opacity:0;transition:opacity .3s" />'+ html;
      }
      return html;
    }

    function getFileIcon(fileType){
      const t = (fileType||'').toLowerCase();
      if(t.includes('audio')) return 'ðŸŽµ';
      if(t.includes('video')) return 'ðŸŽ¬';
      if(t.includes('image')) return 'ðŸ–¼ï¸';
      if(t.includes('pdf')) return 'ðŸ“„';
      if(t.includes('doc')) return 'ðŸ“';
      if(t.includes('xls')||t.includes('sheet')) return 'ðŸ“Š';
      return 'ðŸ“';
    }

    function show(type,msg){
      alertBox.className = 'alert ' + (type||'');
      alertBox.textContent = msg;
      alertBox.style.display = 'block';
      clearTimeout(show._t);
      show._t = setTimeout(()=>{ alertBox.style.display='none'; }, type==='error'?6000:3000);
    }

    function setConn(ok){
      connGood = !!ok;
      connectionStatus.textContent = ok ? 'Connected' : 'Connection Error';
      connectionStatus.classList.toggle('bad', !ok);
    }

    // ===== API =====
    async function fetchJSON(url, opts){
      const res = await fetch(url, opts);
      if(!res.ok) throw new Error(res.status + ' ' + res.statusText);
      return res.json();
    }

    async function xano(endpoint, opts={}){
      try{
        const res = await fetch(`${XANO_PROXY_BASE}/${endpoint}`, {
          headers: { 'Content-Type': 'application/json' },
          ...opts
        });
        if(!res.ok) throw new Error(res.status + ' ' + res.statusText);
        const data = await res.json();
        setConn(true);
        return data;
      } catch(e){
        console.error('Xano error:', e);
        setConn(false);
        show('error', 'Xano: ' + e.message);
        return null;
      }
    }

    // ===== Local Memory (datalists) =====
    const LS_TITLES = 'voxpro_titles';
    const LS_STATIONS = 'voxpro_stations';

    function readSet(key){
      try { return new Set(JSON.parse(localStorage.getItem(key)||'[]')); }
      catch{ return new Set(); }
    }
    function writeSet(key,set){ localStorage.setItem(key, JSON.stringify([...set].slice(0,300))); }

    function addMemory(){
      const t = (titleInput.value||'').trim();
      const s = (stationInput.value||'').trim();
      if(t){ const set = readSet(LS_TITLES); set.delete(t); set.add(t); writeSet(LS_TITLES,set); }
      if(s){ const set = readSet(LS_STATIONS); set.delete(s); set.add(s); writeSet(LS_STATIONS,set); }
      populateDatalistsFromMemory();
    }

    function populateDatalistsFromMemory(){
      const titles = [...readSet(LS_TITLES)];
      const stations = [...readSet(LS_STATIONS)];
      titleOptions.innerHTML = titles.slice(-200).reverse().map(v=>`<option value="${esc(v)}">`).join('');
      stationOptions.innerHTML = stations.slice(-200).reverse().map(v=>`<option value="${esc(v)}">`).join('');
    }

    // ===== Search =====
    async function unifiedSearch(term=''){
      if(unifiedSearch._t) clearTimeout(unifiedSearch._t);
      return new Promise((resolve)=>{
        unifiedSearch._t = setTimeout(async ()=>{
          try{
            const q = term.trim();
            const endpoints = searchEndpointChosen ? [searchEndpointChosen] : [SEARCH_API_PRIMARY, SEARCH_API_SECONDARY].filter(Boolean);
            let data = null; let lastErr = null;
            for(const ep of endpoints){
              try{
                const url = ep + '?' + (q ? ('q=' + encodeURIComponent(q) + '&') : '') + 'limit=100';
                data = await fetchJSON(url);
                searchEndpointChosen = ep;
                break;
              }catch(e){ lastErr = e; }
            }
            if(!data){
              // fallback to Xano list + client-side filter
              const assets = await xano('asset');
              if(!assets) throw lastErr || new Error('No search endpoint responded');
              const qlc = q.toLowerCase();
              const filtered = (assets||[]).filter(a=>{
                const hay = [a.title,a.description,a.station,a.tags,a.submitted_by].map(v=>(v||'').toLowerCase()).join(' ');
                return !qlc || hay.includes(qlc);
              }).map(x=>({
                id: 'xano:'+x.id,
                source:'xano',
                title: x.title||'Untitled',
                description: x.description||'',
                station: x.station||'',
                tags: x.tags||'',
                thumbnail: x.thumbnail||'',
                media_url: x.database_url || x.file_url || x.url || '',
                file_type: x.file_type||'',
                submitted_by: x.submitted_by||'',
                created_at: x.created_at||''
              }));
              data = { results: filtered };
            }
            unifiedResults = data.results || [];
            renderMediaBrowser();
            setConn(true);
            resolve(unifiedResults);
          } catch(e){
            console.error(e);
            setConn(false);
            show('error','Search failed');
            resolve([]);
          }
        }, 180);
      });
    }

    function renderMediaBrowser(){
      if(!unifiedResults.length){
        mediaBrowser.innerHTML = '<div class="row"><div class="info">No media found</div></div>';
        return;
      }
      mediaBrowser.innerHTML = unifiedResults.map(r=>
        `<div class="row" data-id="${esc(r.id)}">
           <div class="thumb">${createThumbnail(r)}</div>
           <div class="info">
             <div class="title">${esc(r.title||'Untitled')}</div>
             <div class="meta">${esc(r.station||'Unknown')} â€¢ ${esc(r.source||'')}</div>
           </div>
         </div>`
      ).join('');

      mediaBrowser.querySelectorAll('.row[data-id]').forEach(el=>{
        el.addEventListener('click', ()=>{
          mediaBrowser.querySelectorAll('.row').forEach(n=>n.classList.remove('selected'));
          el.classList.add('selected');
          const id = el.getAttribute('data-id');
          const asset = unifiedResults.find(x=> String(x.id)===String(id));
          if(asset) selectUnifiedAsset(asset);
        });
        el.addEventListener('dblclick', ()=>{
          const id = el.getAttribute('data-id');
          const asset = unifiedResults.find(x=> String(x.id)===String(id));
          if(asset) openMediaModal(asset);
        });
      });
    }

    function selectUnifiedAsset(asset){
      selectedUnified = asset;
      selectedMedia.textContent = `Selected (${asset.source}): ${asset.title||'Untitled'}`;
      titleInput.value = asset.title || '';
      descriptionInput.value = asset.description || '';
      stationInput.value = asset.station || '';
      tagsInput.value = asset.tags || '';
      submittedByInput.value = asset.submitted_by || '';
      const editable = asset.source === 'xano';
      [titleInput,descriptionInput,stationInput,tagsInput,submittedByInput].forEach(i=>{ i.readOnly = !editable; });
    }

    // ===== Assignments =====
    async function loadAssignments(){
      const data = await xano('voxpro_assignments');
      if(!data){ assignments=[]; forceUpdateUI(); return; }
      assignments = data.sort((a,b)=> (a.key_number||0)-(b.key_number||0));
      for(const a of assignments){
        if(a.asset_id!=null){
          const asset = await xano('asset/'+a.asset_id);
          a.asset = asset || { id:a.asset_id, title:`Missing Asset ${a.asset_id}`, station:'Unknown', file_type:'unknown' };
        } else {
          a.asset = { title:'No Asset ID', station:'Unknown', file_type:'none' };
        }
      }
      forceUpdateUI();
    }

    function forceUpdateUI(){
      renderAssignments();
      updateKeyButtons();
      renderAssignmentsManager();
    }

    function renderAssignments(){
      if(!assignments.length){
        assignmentsList.innerHTML = '<div class="row"><div class="info">No assignments yet</div></div>';
        return;
      }
      assignmentsList.innerHTML = assignments.map(a=>{
        const asset = a.asset||{};
        return `<div class="row" data-assign-id="${a.id}">
          <div class="thumb">${createThumbnail(asset)}</div>
          <div class="info">
            <div class="title">Key ${a.key_number||'?'} â€” ${esc(asset.title||'Unknown')}</div>
            <div class="meta">${esc(asset.station||'Unknown')} â€¢ ${esc(asset.file_type||'')}</div>
          </div>
        </div>`;
      }).join('');
    }

    function renderAssignmentsManager(){
      if(!assignments.length){
        assignmentsListManager.innerHTML = '<div class="row"><div class="info">No assignments yet</div></div>';
        return;
      }
      assignmentsListManager.innerHTML = assignments.map(a=>{
        const asset = a.asset||{};
        return `<div class="row">
          <div class="info">
            <div class="title">Key ${a.key_number||'?'}</div>
            <div class="meta">${esc(asset.title||'Unknown')} â€¢ ${esc(asset.station||'Unknown')}</div>
          </div>
          <div>
            <button class="btn btn-danger" data-del-id="${a.id}">Remove</button>
          </div>
        </div>`;
      }).join('');
      assignmentsListManager.querySelectorAll('[data-del-id]').forEach(btn=>{
        btn.addEventListener('click', ()=> deleteAssignment(btn.getAttribute('data-del-id')));
      });
    }

    function updateKeyButtons(){
      keyButtons.forEach(btn=>{
        btn.classList.remove('assigned','playing');
        const key = Number(btn.dataset.key);
        const asn = assignments.find(a=> Number(a.key_number)===key);
        if(asn) btn.classList.add('assigned');
      });
      reflectPlaying();
    }

    function reflectPlaying(){
      keyButtons.forEach(btn=> btn.classList.remove('playing'));
      if(playing && playing.key){
        const btn = keyButtons.find(b=> Number(b.dataset.key)===Number(playing.key));
        if(btn) btn.classList.add('playing');
        currentInfo.style.display = 'block';
        currentTitle.textContent = playing.asset?.title ? `Now Playing â€” ${playing.asset.title}` : 'Now Playing';
        currentMeta.textContent = [playing.asset?.station||'', playing.asset?.file_type||''].filter(Boolean).join(' â€¢ ');
      } else {
        currentInfo.style.display = 'none';
      }
    }

    async function ensureXanoAssetFromUnified(asset){
      if(!asset) return null;
      if(asset.source==='xano'){
        const idStr = String(asset.id||'').split(':')[1] || String(asset.id);
        const nid = Number(idStr);
        return Number.isFinite(nid) ? nid : null;
      }
      // Create in Xano if external
      const payload = {
        title: asset.title || 'Untitled',
        description: asset.description || '',
        station: asset.station || '',
        tags: asset.tags || '',
        thumbnail: asset.thumbnail || '',
        database_url: asset.media_url || asset.url || '',
        file_url: asset.file_url || '',
        file_type: asset.file_type || '',
        submitted_by: asset.submitted_by || ''
      };
      const created = await xano('asset', { method:'POST', body: JSON.stringify(payload) });
      return created && created.id ? Number(created.id) : null;
    }

    async function assignSelectedToKey(){
      const key = Number(keySelect.value);
      if(!key){ show('error','Choose a key slot'); return; }
      if(!selectedUnified){ show('error','Select a media item first'); return; }
      const assetId = await ensureXanoAssetFromUnified(selectedUnified);
      if(!assetId){ show('error','Could not resolve asset'); return; }

      // If editable (xano), capture any edits
      if(selectedUnified.source==='xano'){
        const updates = {
          title: titleInput.value||'',
          description: descriptionInput.value||'',
          station: stationInput.value||'',
          tags: tagsInput.value||'',
          submitted_by: submittedByInput.value||''
        };
        await xano('asset/'+assetId, { method:'PUT', body: JSON.stringify(updates) });
      }

      addMemory();

      const existing = assignments.find(a=> Number(a.key_number)===key);
      if(existing){
        await xano('voxpro_assignments/'+existing.id, { method:'PUT', body: JSON.stringify({ key_number:key, asset_id: assetId }) });
      } else {
        await xano('voxpro_assignments', { method:'POST', body: JSON.stringify({ key_number:key, asset_id: assetId }) });
      }
      show('success','Key assigned');
      await loadAssignments();
      updateKeyButtons();
    }

    async function deleteAssignment(id){
      if(!id) return;
      await xano('voxpro_assignments/'+id, { method:'DELETE' });
      show('success','Assignment removed');
      await loadAssignments();
    }

    // ===== Player / Modal =====
    function clearActiveMedia(){
      try{ if(activeMediaEl){ activeMediaEl.pause?.(); activeMediaEl.src=''; } }catch{}
      activeMediaEl = null;
    }

    function openMediaModal(asset){
      mediaPlayer.innerHTML='';
      mediaDescription.textContent = asset.description||'';
      modalTitle.textContent = asset.title || 'Player';

      const url = asset.media_url || asset.database_url || asset.file_url || asset.url || '';
      const type = (asset.file_type||'').toLowerCase();

      let el = null;
      if(type.includes('audio')){
        el = document.createElement('audio');
        el.controls = true; el.autoplay = true;
        const src = document.createElement('source');
        src.src = url; el.appendChild(src);
      } else if(type.includes('video')){
        el = document.createElement('video');
        el.controls = true; el.autoplay = true; el.style.maxWidth='100%'; el.style.maxHeight='100%';
        const src = document.createElement('source');
        src.src = url + '#t=0.1'; el.appendChild(src);
      } else if(type.includes('image')){
        el = document.createElement('img');
        el.alt = asset.title||''; el.src = url; el.style.maxWidth='100%'; el.style.maxHeight='100%';
      } else {
        const div = document.createElement('div');
        div.style.padding='16px';
        div.textContent = 'Preview not available';
        el = div;
      }
      mediaPlayer.appendChild(el);
      if(el.tagName==='AUDIO' || el.tagName==='VIDEO') activeMediaEl = el;

      mediaModal.style.display='block';
    }

    function closeMediaModal(){
      clearActiveMedia();
      mediaModal.style.display='none';
    }

    async function playKey(keyNum){
      const asn = assignments.find(a=> Number(a.key_number)===Number(keyNum));
      if(!asn){ show('error','No assignment for that key'); return; }
      const asset = asn.asset || {};
      playing = { key: keyNum, asset };
      reflectPlaying();
      openMediaModal(asset);
    }

    function stopPlayback(){
      playing = null; reflectPlaying();
      clearActiveMedia();
    }

    // ===== Events & Init =====
    document.addEventListener('DOMContentLoaded', async ()=>{
      populateDatalistsFromMemory();
      await loadAssignments();
      await unifiedSearch('');
      setInterval(loadAssignments, ASSIGNMENTS_REFRESH_MS);
    });

    searchInput.addEventListener('input', ()=>{ unifiedSearch(searchInput.value); });
    assignButton.addEventListener('click', assignSelectedToKey);

    keyButtons.forEach(btn=>{
      btn.addEventListener('click', ()=> playKey(btn.dataset.key));
    });

    stopButton.addEventListener('click', stopPlayback);
    modalClose.addEventListener('click', closeMediaModal);
    mediaModal.addEventListener('click', (e)=>{ if(e.target===mediaModal) closeMediaModal(); });

    // Keyboard: 1-5 to play, Space to stop, Esc to close modal
    window.addEventListener('keydown', (e)=>{
      const k = e.key;
      if(/[1-5]/.test(k)){
        playKey(Number(k));
      } else if(k===' '){
        e.preventDefault(); stopPlayback();
      } else if(k==='Escape'){
        closeMediaModal();
      }
    });
  </script>
</body>
</html>

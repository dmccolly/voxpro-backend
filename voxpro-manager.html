<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1.0" />
<title>VoxPro Manager ‚Äî Webflow + Netlify + Xano</title>
<style>
  :root { --bg-dark:#121212; --bg-panel:#1e1e1e; --bg-input:#242424; --text:#fff; --muted:#b0b0b0; --accent:#00ff88; --blue:#0066ff; --red:#ff4444; --border:#333; --shadow:0 8px 30px rgba(0,0,0,.35); }
  *{box-sizing:border-box;margin:0;padding:0}
  body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,Inter,Arial,sans-serif;background:var(--bg-dark);color:var(--text);min-height:100vh;padding:24px}
  .container{max-width:1400px;margin:0 auto;display:grid;grid-template-columns:1fr 1fr;gap:28px}
  .panel{background:var(--bg-panel);border:1px solid var(--border);border-radius:14px;box-shadow:var(--shadow);padding:22px}
  .panel-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:18px;padding-bottom:12px;border-bottom:2px solid var(--accent)}
  .panel-title{font-size:22px;font-weight:800;color:var(--accent)}
  .status{padding:6px 12px;border-radius:999px;font-size:12px;font-weight:800;color:#111;background:var(--accent)}
  .status.bad{background:var(--red)}
  .grid-keys{display:grid;grid-template-columns:repeat(2,1fr);gap:14px;margin-bottom:18px}
  .key{background:linear-gradient(145deg,#444,#262626);border:2px solid var(--border);border-radius:12px;min-height:86px;padding:18px;font-size:18px;font-weight:800;color:#fff;cursor:pointer;transition:.2s;display:flex;align-items:center;justify-content:center}
  .key:hover{border-color:var(--accent);box-shadow:0 0 18px rgba(0,255,136,.35)}
  .key.assigned{background:linear-gradient(145deg,var(--blue),#003fb6);border-color:var(--blue)}
  .key.playing{background:linear-gradient(145deg,var(--accent),#05c86e);border-color:var(--accent);box-shadow:0 0 24px rgba(0,255,136,.6)}
  .grid-keys .key:nth-child(5){grid-column:1/-1;justify-self:center;width:220px}
  .stop{background:linear-gradient(145deg,var(--red),#cc0000);border:2px solid var(--red);border-radius:12px;color:#fff;padding:12px 24px;font-weight:800;cursor:pointer}
  .section-title{font-size:16px;font-weight:800;color:var(--accent);margin:18px 0 10px}
  .list{background:var(--bg-input);border:1px solid var(--border);border-radius:10px;max-height:320px;overflow:auto}
  .row{display:flex;gap:12px;align-items:center;padding:12px;border-bottom:1px solid var(--border);cursor:pointer}
  .row:last-child{border-bottom:none}
  .row:hover{background:rgba(0,255,136,.07)}
  .row.selected{background:rgba(0,255,136,.14);border-left:4px solid var(--accent)}
  .thumb{width:64px;height:64px;border-radius:8px;background:#0b0b0b;display:flex;align-items:center;justify-content:center;font-size:14px;color:#bbb;overflow:hidden;position:relative}
  .thumb img,.thumb video{width:100%;height:100%;object-fit:cover;border-radius:8px;position:absolute;top:0;left:0}
  .thumb .icon{position:relative;z-index:2;font-size:18px}
  .info{flex:1}
  .title{font-weight:700}
  .meta{font-size:12px;color:var(--muted);margin-top:2px}
  .label{display:block;margin:12px 0 6px;color:var(--muted);font-size:13px;font-weight:700}
  .input,.select,.textarea{width:100%;background:var(--bg-input);border:1px solid var(--border);border-radius:8px;color:#fff;padding:12px;font-size:14px}
  .textarea{min-height:96px;resize:vertical}
  .btn{background:var(--accent);border:none;color:#111;padding:12px 18px;border-radius:8px;font-weight:800;cursor:pointer}
  .btn:hover{filter:brightness(.95)}
  .btn-danger{background:var(--red);color:#fff}
  .alert{margin-bottom:12px;padding:12px;border-radius:10px;border:1px solid;display:none}
  .alert.error{display:block;background:rgba(255,68,68,.1);border-color:#ff5f5f;color:#ff7c7c}
  .alert.success{display:block;background:rgba(0,255,136,.1);border-color:#06d97d;color:#00ff88}
  .current{background:#0c0c0c;border:1px solid var(--border);border-radius:10px;padding:14px;margin-top:12px}
  .current .h{color:var(--accent);font-weight:800;margin-bottom:6px}

  /* Modal */
  .modal{display:none;position:fixed;inset:0;background:rgba(0,0,0,.78);z-index:9999}
  .sheet{
    position:fixed; left:20px; bottom:20px; width:500px; height:500px; min-width:360px; min-height:320px;
    background:var(--bg-panel); border:2px solid var(--accent); border-radius:12px; box-shadow:0 10px 40px rgba(0,0,0,.5);
    display:flex; flex-direction:column; overflow:hidden;
  }
  .sheet-h{background:var(--accent);color:#111;padding:12px 14px;font-weight:900;display:flex;justify-content:space-between;align-items:center;cursor:move;user-select:none}
  .sheet-x{background:none;border:none;font-size:22px;font-weight:900;color:#111;cursor:pointer}
  .sheet-body{padding:14px;display:flex;flex-direction:column;gap:12px;height:100%}
  .media{flex:1;background:#0e0e0e;border-radius:8px;display:flex;align-items:center;justify-content:center;overflow:hidden;position:relative}
  .desc{background:rgba(0,0,0,.28);border:1px solid var(--border);border-radius:8px;padding:12px;color:#b0b0b0;max-height:150px;overflow:auto}
  /* Resizer handle */
  .sheet-resize{position:absolute;right:6px;bottom:6px;width:16px;height:16px;cursor:nwse-resize;opacity:.7}
  .sheet-resize:before{content:'';position:absolute;right:0;bottom:0;width:100%;height:100%;
    background:linear-gradient(135deg, transparent 0 40%, rgba(255,255,255,.35) 40% 60%, transparent 60% 100%); }

  /* Tap-to-play overlay */
  .tap-overlay{position:absolute;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.45)}
  .tap-overlay .btn{font-size:14px}
  @media(max-width:980px){.container{grid-template-columns:1fr}}
</style>

<!-- pdf.js (thumbs + embed helper) -->
<script defer src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
<script>window.addEventListener('load',()=>{if(window.pdfjsLib){window.pdfjsLib.GlobalWorkerOptions.workerSrc='https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';}});</script>
</head>
<body>
  <div class="container">
    <section class="panel">
      <div class="panel-header">
        <div class="panel-title">VoxPro Media Player</div>
        <div class="status" id="connectionStatus">Connecting‚Ä¶</div>
      </div>
      <div class="grid-keys" id="keyGrid">
        <button class="key" data-key="1">KEY 1</button>
        <button class="key" data-key="2">KEY 2</button>
        <button class="key" data-key="3">KEY 3</button>
        <button class="key" data-key="4">KEY 4</button>
        <button class="key" data-key="5">KEY 5</button>
      </div>
      <button class="stop" id="stopButton">STOP</button>
      <div class="section-title">Current Key Assignments</div>
      <div class="list" id="assignmentsList"><div class="row"><div class="info">Loading assignments‚Ä¶</div></div></div>
      <div class="current" id="currentInfo" style="display:none;">
        <div class="h" id="currentTitle">Now Playing</div>
        <div class="meta" id="currentMeta"></div>
      </div>
    </section>

    <section class="panel">
      <div class="panel-header">
        <div class="panel-title">VoxPro Manager</div>
        <div style="font-size:12px;color:#b0b0b0">Search Webflow + Xano (with Xano fallback)</div>
      </div>

      <div id="alert" class="alert"></div>

      <label class="label" for="searchInput">Search Media (title, description, station, tags)</label>
      <input class="input" id="searchInput" placeholder="Type to search‚Ä¶ or leave empty for recent">

      <div class="list" id="mediaBrowser" style="margin-top:10px">
        <div class="row"><div class="info">Waiting for search‚Ä¶</div></div>
      </div>

      <div id="selectedMedia" class="meta" style="margin-top:8px;"></div>

      <label class="label">Select Key Slot</label>
      <select class="select" id="keySelect">
        <option value="">Choose a key‚Ä¶</option>
        <option value="1">Key 1</option>
        <option value="2">Key 2</option>
        <option value="3">Key 3</option>
        <option value="4">Key 4</option>
        <option value="5">Key 5</option>
      </select>

      <label class="label" for="titleInput">Title</label>
      <input class="input" id="titleInput" placeholder="Title" list="titleOptions" readonly>
      <datalist id="titleOptions"></datalist>

      <label class="label" for="descriptionInput">Description</label>
      <textarea class="textarea" id="descriptionInput" placeholder="Description" readonly></textarea>

      <label class="label" for="stationInput">Station</label>
      <input class="input" id="stationInput" placeholder="Station" list="stationOptions" readonly>
      <datalist id="stationOptions"></datalist>

      <label class="label" for="tagsInput">Tags</label>
      <input class="input" id="tagsInput" placeholder="Comma-separated" readonly>

      <label class="label" for="submittedByInput">Submitted By</label>
      <input class="input" id="submittedByInput" placeholder="Name or initials" readonly>

      <div style="margin-top:14px;display:flex;gap:10px">
        <button class="btn" id="assignButton" style="flex:1">Assign / Update Key</button>
      </div>

      <div class="section-title">Current Assignments</div>
      <div class="list" id="assignmentsListManager">
        <div class="row"><div class="info">Loading‚Ä¶</div></div>
      </div>
    </section>
  </div>

  <div class="modal" id="mediaModal">
    <div class="sheet" id="sheet">
      <div class="sheet-h" id="sheetHeader">
        <span id="modalTitle">Player</span>
        <button class="sheet-x" id="modalClose">√ó</button>
      </div>
      <div class="sheet-body">
        <div class="media" id="mediaPlayer">
          <div class="tap-overlay" id="tapOverlay"><button class="btn" id="tapPlayBtn">Tap to play</button></div>
        </div>
        <div class="desc" id="mediaDescription"></div>
      </div>
      <div class="sheet-resize" id="sheetResize" aria-hidden="true"></div>
    </div>
  </div>

<script>
  // ===== Config (Webflow + Netlify Functions + Xano) =====
  const SEARCH_API_PRIMARY = 'https://majestic-beijinho-cd3d75.netlify.app/.netlify/functions/search-media';
  const SEARCH_API_SECONDARY = '';
  const XANO_PROXY_BASE = 'https://majestic-beijinho-cd3d75.netlify.app/.netlify/functions/xano-proxy';
  const ASSIGNMENTS_REFRESH_MS = 30000;

  // ===== State =====
  let unifiedResults = [];
  let assignments = [];
  let selectedUnified = null;
  let playing = null;
  let connGood = false;
  let searchEndpointChosen = null;
  let activeMediaEl = null;

  // ===== DOM =====
  const keyButtons = [...document.querySelectorAll('.key[data-key]')];
  const stopButton = document.getElementById('stopButton');
  const assignmentsList = document.getElementById('assignmentsList');
  const assignmentsListManager = document.getElementById('assignmentsListManager');
  const connectionStatus = document.getElementById('connectionStatus');
  const searchInput = document.getElementById('searchInput');
  const mediaBrowser = document.getElementById('mediaBrowser');
  const selectedMedia = document.getElementById('selectedMedia');
  const keySelect = document.getElementById('keySelect');
  const titleInput = document.getElementById('titleInput');
  const descriptionInput = document.getElementById('descriptionInput');
  const stationInput = document.getElementById('stationInput');
  const tagsInput = document.getElementById('tagsInput');
  const submittedByInput = document.getElementById('submittedByInput');
  const assignButton = document.getElementById('assignButton');
  const alertBox = document.getElementById('alert');
  const currentInfo = document.getElementById('currentInfo');
  const currentTitle = document.getElementById('currentTitle');
  const currentMeta = document.getElementById('currentMeta');
  const mediaModal = document.getElementById('mediaModal');
  const modalClose = document.getElementById('modalClose');
  const modalTitle = document.getElementById('modalTitle');
  const mediaPlayer = document.getElementById('mediaPlayer');
  const mediaDescription = document.getElementById('mediaDescription');
  const titleOptions = document.getElementById('titleOptions');
  const stationOptions = document.getElementById('stationOptions');
  const sheet = document.getElementById('sheet');
  const sheetHeader = document.getElementById('sheetHeader');
  const sheetResize = document.getElementById('sheetResize');
  const tapOverlay = document.getElementById('tapOverlay');
  const tapPlayBtn = document.getElementById('tapPlayBtn');

  // ===== Utils =====
  const esc = (s)=> (s||'').toString().replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));

  function show(type,msg){
    alertBox.className = 'alert ' + (type||'');
    alertBox.textContent = msg;
    alertBox.style.display = 'block';
    clearTimeout(show._t);
    show._t = setTimeout(()=>{ alertBox.style.display='none'; }, type==='error'?6000:3000);
  }

  function setConn(ok){
    connGood = !!ok;
    connectionStatus.textContent = ok ? 'Connected' : 'Connection Error';
    connectionStatus.classList.toggle('bad', !ok);
  }

  // ===== API helpers =====
  async function fetchJSON(url, opts){ const r=await fetch(url,opts); if(!r.ok) throw new Error(r.status+' '+r.statusText); return r.json(); }
  async function xano(endpoint, opts={}) {
    try{
      const r=await fetch(`${XANO_PROXY_BASE}/${endpoint}`, { headers:{'Content-Type':'application/json'}, ...opts });
      if(!r.ok) throw new Error(r.status+' '+r.statusText);
      const j=await r.json(); setConn(true); return j;
    }catch(e){ console.error('Xano error:',e); setConn(false); show('error','Xano: '+e.message); return null; }
  }

  // ===== Local memory (datalists) =====
  const LS_TITLES='voxpro_titles', LS_STATIONS='voxpro_stations';
  const readSet=k=>{try{return new Set(JSON.parse(localStorage.getItem(k)||'[]'))}catch{return new Set()}};
  const writeSet=(k,s)=>localStorage.setItem(k,JSON.stringify([...s].slice(0,300)));
  function addMemory(){
    const t=(titleInput.value||'').trim(), s=(stationInput.value||'').trim();
    if(t){const set=readSet(LS_TITLES); set.delete(t); set.add(t); writeSet(LS_TITLES,set);}
    if(s){const set=readSet(LS_STATIONS); set.delete(s); set.add(s); writeSet(LS_STATIONS,set);}
    populateDatalistsFromMemory();
  }
  function populateDatalistsFromMemory(){
    const titles=[...readSet(LS_TITLES)], stations=[...readSet(LS_STATIONS)];
    titleOptions.innerHTML=titles.slice(-200).reverse().map(v=>`<option value="${esc(v)}">`).join('');
    stationOptions.innerHTML=stations.slice(-200).reverse().map(v=>`<option value="${esc(v)}">`).join('');
  }

  // ===== Type detect & thumbs =====
  function detectType(item){
    const t=(item.file_type||'').toLowerCase(); if(t) return t;
    const u=(item.media_url||item.database_url||item.file_url||item.url||'').toLowerCase();
    if(/\.(mp3|m4a|aac|wav|ogg|flac)(\?|$)/.test(u)) return 'audio';
    if(/\.(mp4|mov|mkv|webm)(\?|$)/.test(u)) return 'video';
    if(/\.(png|jpg|jpeg|gif|webp|avif)(\?|$)/.test(u)) return 'image';
    if(/\.pdf(\?|$)/.test(u)) return 'pdf';
    if(/\.(doc|docx)(\?|$)/.test(u)) return 'doc';
    if(/\.(xls|xlsx|csv)(\?|$)/.test(u)) return 'sheet';
    return '';
  }

  async function createVideoThumb(url){
    return new Promise(resolve=>{
      try{
        const v=document.createElement('video'); v.muted=true; v.preload='metadata'; v.src=url+(url.includes('#')?'':'#t=0.2'); v.playsInline=true;
        v.onloadeddata=()=>{
          const c=document.createElement('canvas'); c.width=128; c.height=128; const g=c.getContext('2d');
          const r=Math.min(128/v.videoWidth,128/v.videoHeight); const w=v.videoWidth*r, h=v.videoHeight*r;
          g.fillStyle='#0b0b0b'; g.fillRect(0,0,128,128); g.drawImage(v,(128-w)/2,(128-h)/2,w,h);
          resolve(c.toDataURL('image/png'));
        };
        v.onerror=()=>resolve(null);
      }catch{ resolve(null); }
    });
  }

  let _pdfReady=null;
  function loadPdfJs(){
    if(_pdfReady) return _pdfReady;
    _pdfReady=new Promise((res,rej)=>{
      function go(){
        try{
          if(!window.pdfjsLib) throw new Error('pdf.js missing');
          window.pdfjsLib.GlobalWorkerOptions.workerSrc='https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
          res(window.pdfjsLib);
        }catch(e){ rej(e); }
      }
      if(window.pdfjsLib) return go();
      const t=setInterval(()=>{ if(window.pdfjsLib){ clearInterval(t); go(); } },200);
      setTimeout(()=>{ if(!window.pdfjsLib){ rej(new Error('pdf.js not loaded')); } },5000);
    }).catch(()=>null);
    return _pdfReady;
  }

  async function pdfPageThumb(url){
    const pdfjs=await loadPdfJs(); if(!pdfjs) return null;
    try{
      const pdf=await pdfjs.getDocument(url).promise;
      const page=await pdf.getPage(1);
      const viewport=page.getViewport({scale:.5});
      const c=document.createElement('canvas'); const g=c.getContext('2d'); c.width=128; c.height=128;
      const scale=Math.min(c.width/viewport.width,c.height/viewport.height);
      const v2=page.getViewport({scale});
      const off=document.createElement('canvas'); off.width=v2.width; off.height=v2.height;
      await page.render({canvasContext:off.getContext('2d'),viewport:v2}).promise;
      g.fillStyle='#0b0b0b'; g.fillRect(0,0,c.width,c.height);
      g.drawImage(off,(c.width-off.width)/2,(c.height-off.height)/2);
      return c.toDataURL('image/png');
    }catch{ return null; }
  }

  const audioWaveThumbCache=new Map();
  async function renderAudioWaveThumb(url){
    if(audioWaveThumbCache.has(url)) return audioWaveThumbCache.get(url);
    try{
      const AC=window.AudioContext||window.webkitAudioContext; if(!AC) return null;
      const ctx=new AC();
      const resp=await fetch(url,{mode:'cors'});
      if(!resp.ok) throw new Error('audio fetch failed');
      const buf=await resp.arrayBuffer();
      const audio=await ctx.decodeAudioData(buf);
      const ch=audio.getChannelData(0);
      const c=document.createElement('canvas'); c.width=128; c.height=128; const g=c.getContext('2d');
      g.fillStyle='#0b0b0b'; g.fillRect(0,0,128,128);
      g.strokeStyle='#00ff88'; g.lineWidth=1; g.beginPath();
      const samples=1000, step=Math.max(1,Math.floor(ch.length/samples));
      for(let x=0;x<128;x++){
        const start=Math.min(ch.length-1, Math.floor((x/128)*samples)*step);
        const end=Math.min(ch.length-1, start+step);
        let min=1,max=-1; for(let i=start;i<end;i++){ const v=ch[i]; if(v<min)min=v; if(v>max)max=v; }
        const y1=64+min*60, y2=64+max*60; g.moveTo(x,y1); g.lineTo(x,y2);
      }
      g.stroke();
      const data=c.toDataURL('image/png');
      audioWaveThumbCache.set(url,data);
      return data;
    }catch{ return null; } // gracefully fallback
  }

  async function createThumbnail(item){
    const mediaUrl=item.media_url||item.database_url||item.file_url||item.url||'';
    const turl=item.thumbnail||'';
    const type=detectType(item);

    if(turl){ return `<img src="${esc(turl)}" onload="this.style.opacity=1" onerror="this.style.display='none'" style="opacity:0;transition:opacity .3s">`; }
    if(type.includes('image') && mediaUrl){ return `<img src="${esc(mediaUrl)}" onload="this.style.opacity=1" onerror="this.style.display='none'" style="opacity:0;transition:opacity .3s">`; }
    if(type.includes('video') && mediaUrl){
      const data=await createVideoThumb(mediaUrl);
      return data ? `<img src="${data}">` : `<video muted preload="metadata" playsinline><source src="${esc(mediaUrl)}#t=1"></video>`;
    }
    if(type.includes('pdf') && mediaUrl){
      const data=await pdfPageThumb(mediaUrl);
      return data ? `<img src="${data}">` : '<div class="icon">üìÑ</div>';
    }
    if(type.includes('audio') && mediaUrl){
      const data=await renderAudioWaveThumb(mediaUrl);
      return data ? `<img src="${data}" alt="waveform">` : '<div class="icon">üéµ</div>';
    }
    if(type.includes('doc')) return '<div class="icon">üìù</div>';
    if(type.includes('sheet')) return '<div class="icon">üìä</div>';
    return '<div class="icon">üìÅ</div>';
  }

  // ===== Search =====
  async function unifiedSearch(term=''){
    if(unifiedSearch._t) clearTimeout(unifiedSearch._t);
    return new Promise((resolve)=>{
      unifiedSearch._t=setTimeout(async()=>{
        try{
          const q=term.trim();
          const endpoints=searchEndpointChosen?[searchEndpointChosen]:[SEARCH_API_PRIMARY,SEARCH_API_SECONDARY].filter(Boolean);
          let data=null, lastErr=null;
          for(const ep of endpoints){
            try{
              const url=ep+'?'+(q?('q='+encodeURIComponent(q)+'&'):'')+'limit=100';
              data=await fetchJSON(url);
              searchEndpointChosen=ep; break;
            }catch(e){ lastErr=e; }
          }
          if(!data){
            const assets=await xano('asset');
            if(!assets) throw lastErr||new Error('No search endpoint responded');
            const qlc=q.toLowerCase();
            const filtered=(assets||[]).filter(a=>{
              const hay=[a.title,a.description,a.station,a.tags,a.submitted_by].map(v=>(v||'').toLowerCase()).join(' ');
              return !qlc || hay.includes(qlc);
            }).map(x=>({
              id:'xano:'+x.id, source:'xano',
              title:x.title||'Untitled', description:x.description||'',
              station:x.station||'', tags:x.tags||'',
              thumbnail:x.thumbnail||'',
              media_url:x.database_url||x.file_url||x.url||'',
              file_type:x.file_type||'',
              submitted_by:x.submitted_by||'', created_at:x.created_at||''
            }));
            data={results:filtered};
          }
          unifiedResults=data.results||[];
          renderMediaBrowser();
          setConn(true);
          resolve(unifiedResults);
        }catch(e){ console.error(e); setConn(false); show('error','Search failed'); resolve([]); }
      },180);
    });
  }

  function renderMediaBrowser(){
    if(!unifiedResults.length){
      mediaBrowser.innerHTML = '<div class="row"><div class="info">No media found</div></div>';
      return;
    }
    mediaBrowser.innerHTML = '';
    unifiedResults.forEach(async (r)=>{
      const row=document.createElement('div'); row.className='row'; row.dataset.id=String(r.id);
      const thumb=document.createElement('div'); thumb.className='thumb'; thumb.innerHTML='<div class="icon">üìÅ</div>';
      try{ thumb.innerHTML=await createThumbnail(r); }catch{}
      const info=document.createElement('div'); info.className='info';
      info.innerHTML = `<div class="title">${esc(r.title||'Untitled')}</div><div class="meta">${esc(r.station||'Unknown')} ‚Ä¢ ${esc(r.source||'')}</div>`;
      row.appendChild(thumb); row.appendChild(info);

      row.addEventListener('click', ()=>{
        mediaBrowser.querySelectorAll('.row').forEach(n=>n.classList.remove('selected'));
        row.classList.add('selected');
        const asset = unifiedResults.find(x=> String(x.id)===String(r.id));
        if(asset) selectUnifiedAsset(asset);
      });
      row.addEventListener('dblclick', ()=>{
        const asset = unifiedResults.find(x=> String(x.id)===String(r.id));
        if(asset) openMediaModal(asset);
      });

      mediaBrowser.appendChild(row);
    });
  }

  function selectUnifiedAsset(asset){
    selectedUnified=asset; selectedMedia.textContent=`Selected (${asset.source}): ${asset.title||'Untitled'}`;
    titleInput.value=asset.title||''; descriptionInput.value=asset.description||''; stationInput.value=asset.station||''; tagsInput.value=asset.tags||''; submittedByInput.value=asset.submitted_by||'';
    const editable=asset.source==='xano'; [titleInput,descriptionInput,stationInput,tagsInput,submittedByInput].forEach(i=>{ i.readOnly = !editable; });
  }

  // ===== Assignments =====
  async function loadAssignments(){
    const data=await xano('voxpro_assignments');
    if(!data){ assignments=[]; forceUpdateUI(); return; }
    assignments=data.sort((a,b)=>(a.key_number||0)-(b.key_number||0));
    for(const a of assignments){
      if(a.asset_id!=null){
        const asset=await xano('asset/'+a.asset_id);
        a.asset=asset||{id:a.asset_id,title:`Missing Asset ${a.asset_id}`,station:'Unknown',file_type:'unknown'};
      } else { a.asset={title:'No Asset ID',station:'Unknown',file_type:'none'}; }
    }
    forceUpdateUI();
  }

  function forceUpdateUI(){ renderAssignments(); updateKeyButtons(); renderAssignmentsManager(); }

  function renderAssignments(){
    if(!assignments.length){
      assignmentsList.innerHTML='<div class="row"><div class="info">No assignments yet</div></div>';
      return;
    }
    assignmentsList.innerHTML=assignments.map(a=>{
      const asset=a.asset||{};
      return `<div class="row" data-assign-id="${a.id}">
        <div class="thumb"><div class="icon">üìÅ</div></div>
        <div class="info">
          <div class="title">Key ${a.key_number||'?'} ‚Äî ${esc(asset.title||'Unknown')}</div>
          <div class="meta">${esc(asset.station||'Unknown')} ‚Ä¢ ${esc(asset.file_type||'')}</div>
        </div>
      </div>`;
    }).join('');
    // async thumb upgrade
    assignmentsList.querySelectorAll('.row').forEach(async (row, idx)=>{
      const a=assignments[idx]; if(!a||!a.asset) return;
      const thumb=row.querySelector('.thumb'); try{ thumb.innerHTML=await createThumbnail(a.asset); }catch{}
    });
  }

  function renderAssignmentsManager(){
    if(!assignments.length){
      assignmentsListManager.innerHTML='<div class="row"><div class="info">No assignments yet</div></div>';
      return;
    }
    assignmentsListManager.innerHTML=assignments.map(a=>{
      const asset=a.asset||{};
      return `<div class="row">
        <div class="info">
          <div class="title">Key ${a.key_number||'?'}</div>
          <div class="meta">${esc(asset.title||'Unknown')} ‚Ä¢ ${esc(asset.station||'Unknown')}</div>
        </div>
        <div><button class="btn btn-danger" data-del-id="${a.id}">Remove</button></div>
      </div>`;
    }).join('');
    assignmentsListManager.querySelectorAll('[data-del-id]').forEach(btn=>{
      btn.addEventListener('click',()=> deleteAssignment(btn.getAttribute('data-del-id')));
    });
  }

  function updateKeyButtons(){
    keyButtons.forEach(btn=>{
      btn.classList.remove('assigned','playing');
      const key=Number(btn.dataset.key);
      const asn=assignments.find(a=>Number(a.key_number)===key);
      if(asn) btn.classList.add('assigned');
    });
    reflectPlaying();
  }

  function reflectPlaying(){
    keyButtons.forEach(btn=> btn.classList.remove('playing'));
    if(playing && playing.key){
      const btn=keyButtons.find(b=> Number(b.dataset.key)===Number(playing.key));
      if(btn) btn.classList.add('playing');
      currentInfo.style.display='block';
      currentTitle.textContent = playing.asset?.title ? `Now Playing ‚Äî ${playing.asset.title}` : 'Now Playing';
      currentMeta.textContent = [playing.asset?.station||'', playing.asset?.file_type||''].filter(Boolean).join(' ‚Ä¢ ');
    } else {
      currentInfo.style.display='none';
    }
  }

  async function ensureXanoAssetFromUnified(asset){
    if(!asset) return null;
    if(asset.source==='xano'){
      const idStr=String(asset.id||'').split(':')[1]||String(asset.id);
      const nid=Number(idStr);
      return Number.isFinite(nid)?nid:null;
    }
    const payload={
      title:asset.title||'Untitled', description:asset.description||'',
      station:asset.station||'', tags:asset.tags||'',
      thumbnail:asset.thumbnail||'',
      database_url:asset.media_url||asset.url||'',
      file_url:asset.file_url||'',
      file_type:asset.file_type||'',
      submitted_by:asset.submitted_by||''
    };
    const created=await xano('asset',{method:'POST', body:JSON.stringify(payload)});
    return created && created.id ? Number(created.id) : null;
  }

  async function assignSelectedToKey(){
    const key=Number(keySelect.value);
    if(!key){ show('error','Choose a key slot'); return; }
    if(!selectedUnified){ show('error','Select a media item first'); return; }

    const assetId=await ensureXanoAssetFromUnified(selectedUnified);
    if(!assetId){ show('error','Could not resolve asset'); return; }

    if(selectedUnified.source==='xano'){
      const updates={ title:titleInput.value||'', description:descriptionInput.value||'', station:stationInput.value||'', tags:tagsInput.value||'', submitted_by:submittedByInput.value||'' };
      await xano('asset/'+assetId,{method:'PUT', body:JSON.stringify(updates)});
    }

    addMemory();

    const existing=assignments.find(a=> Number(a.key_number)===key);
    if(existing){
      await xano('voxpro_assignments/'+existing.id,{method:'PUT', body:JSON.stringify({key_number:key, asset_id:assetId})});
    } else {
      await xano('voxpro_assignments',{method:'POST', body:JSON.stringify({key_number:key, asset_id:assetId})});
    }
    show('success','Key assigned');
    await loadAssignments();
    updateKeyButtons();
  }

  async function deleteAssignment(id){
    if(!id) return;
    await xano('voxpro_assignments/'+id,{method:'DELETE'});
    show('success','Assignment removed');
    await loadAssignments();
  }

  // ===== Player / Modal =====
  function clearActiveMedia(){ try{ if(activeMediaEl){ activeMediaEl.pause?.(); activeMediaEl.src=''; } }catch{} activeMediaEl=null; }

  async function ensurePlayable(el){
    try{
      await el.play();
      tapOverlay.style.display='none';
    }catch{
      tapOverlay.style.display='flex';
      tapPlayBtn.onclick = async ()=>{ try{ await el.play(); tapOverlay.style.display='none'; }catch{} };
    }
  }

  function openMediaModal(asset){
    mediaPlayer.innerHTML='';
    mediaPlayer.appendChild(tapOverlay); // keep overlay
    mediaDescription.textContent = asset.description||'';
    modalTitle.textContent = asset.title || 'Player';

    const url = asset.media_url || asset.database_url || asset.file_url || asset.url || '';
    const type = (asset.file_type || detectType(asset) || '').toLowerCase();

    let el = null;

    if(type.includes('audio')){
      const wrap=document.createElement('div');
      wrap.style.display='grid'; wrap.style.gridTemplateRows='1fr auto'; wrap.style.height='100%';
      const canvas=document.createElement('canvas'); canvas.width=460; canvas.height=220; canvas.style.margin='8px'; canvas.style.background='#0b0b0b';
      const audio=document.createElement('audio'); audio.controls=true; audio.autoplay=false; audio.style.width='100%'; audio.playsInline=true;
      const src=document.createElement('source'); src.src=url; audio.appendChild(src);
      wrap.appendChild(canvas); wrap.appendChild(audio);
      mediaPlayer.prepend(wrap);
      activeMediaEl=audio;

      // best-effort live waveform (doesn't block playback)
      try{
        const AC=window.AudioContext||window.webkitAudioContext;
        if (AC){
          const ctx=new AC();
          const analyser=ctx.createAnalyser(); analyser.fftSize=2048;
          const msrc=ctx.createMediaElementSource(audio); msrc.connect(analyser); analyser.connect(ctx.destination);
          const g=canvas.getContext('2d');
          (function draw(){
            requestAnimationFrame(draw);
            const data=new Uint8Array(analyser.frequencyBinCount);
            analyser.getByteTimeDomainData(data);
            g.clearRect(0,0,canvas.width,canvas.height);
            g.strokeStyle='#00ff88'; g.lineWidth=2; g.beginPath();
            const slice=canvas.width/data.length; let x=0;
            for(let i=0;i<data.length;i++){ const v=(data[i]/128)-1; const y=(canvas.height/2)+v*(canvas.height/2-10); i?g.lineTo(x,y):g.moveTo(x,y); x+=slice; }
            g.stroke();
          })();
        }
      }catch{}

      mediaModal.style.display='block';
      ensurePlayable(audio);
      return;
    }

    if(type.includes('video')){
      el=document.createElement('video'); el.controls=true; el.autoplay=false; el.style.maxWidth='100%'; el.style.maxHeight='100%'; el.playsInline=true; el.muted=false;
      const s=document.createElement('source'); s.src=url+'#t=0.1'; el.appendChild(s);
      mediaPlayer.prepend(el);
      activeMediaEl=el;
      mediaModal.style.display='block';
      ensurePlayable(el);
      return;
    }

    if(type.includes('image')){
      el=document.createElement('img'); el.alt=asset.title||''; el.src=url; el.style.maxWidth='100%'; el.style.maxHeight='100%';
    } else if(type.includes('pdf')){
      el=document.createElement('embed'); el.type='application/pdf'; el.src=url; el.style.width='100%'; el.style.height='100%';
    } else {
      const div=document.createElement('div'); div.style.padding='16px'; div.textContent='Preview not available'; el=div;
    }

    mediaPlayer.prepend(el);
    mediaModal.style.display='block';
  }

  function closeMediaModal(){ clearActiveMedia(); mediaModal.style.display='none'; tapOverlay.style.display='none'; }

  function playKey(keyNum){
    const asn=assignments.find(a=> Number(a.key_number)===Number(keyNum));
    if(!asn){ show('error','No assignment for that key'); return; }
    const asset=asn.asset || {};
    playing = { key:keyNum, asset };
    reflectPlaying();
    openMediaModal(asset);
  }

  function stopPlayback(){ playing=null; reflectPlaying(); clearActiveMedia(); }

  // ===== Draggable (mouse + touch) & JS Resizer =====
  (function dragAndResize(){
    const modal = sheet, header = sheetHeader, grip = sheetResize;

    // Drag
    let dragging=false, startX=0, startY=0, startLeft=0, startTop=0;
    function onDown(x,y){
      dragging=true;
      const rect=modal.getBoundingClientRect();
      startLeft=rect.left; startTop=rect.top;
      startX=x; startY=y;
      modal.style.right='auto'; modal.style.bottom='auto';
      document.body.style.userSelect='none';
    }
    function onMove(x,y){
      if(!dragging) return;
      const dx=x-startX, dy=y-startY;
      modal.style.left=(startLeft+dx)+'px';
      modal.style.top =(startTop +dy)+'px';
    }
    function onUp(){ dragging=false; document.body.style.userSelect=''; }

    header.addEventListener('mousedown',e=>onDown(e.clientX,e.clientY));
    document.addEventListener('mousemove',e=>onMove(e.clientX,e.clientY));
    document.addEventListener('mouseup',onUp);

    header.addEventListener('touchstart',e=>{const t=e.touches[0]; onDown(t.clientX,t.clientY);},{passive:true});
    document.addEventListener('touchmove',e=>{const t=e.touches[0]; onMove(t.clientX,t.clientY);},{passive:true});
    document.addEventListener('touchend',onUp);

    // Resize via grip
    let resizing=false, rStartX=0, rStartY=0, startW=0, startH=0;
    function rDown(x,y){
      resizing=true; rStartX=x; rStartY=y;
      const rect=modal.getBoundingClientRect();
      startW=rect.width; startH=rect.height;
      document.body.style.userSelect='none';
    }
    function rMove(x,y){
      if(!resizing) return;
      const dx=x-rStartX, dy=y-rStartY;
      modal.style.width = Math.max(360, startW+dx)+'px';
      modal.style.height= Math.max(320, startH+dy)+'px';
    }
    function rUp(){ resizing=false; document.body.style.userSelect=''; }

    grip.addEventListener('mousedown',e=>{e.stopPropagation(); rDown(e.clientX,e.clientY);});
    document.addEventListener('mousemove',e=>rMove(e.clientX,e.clientY));
    document.addEventListener('mouseup',rUp);

    grip.addEventListener('touchstart',e=>{e.stopPropagation(); const t=e.touches[0]; rDown(t.clientX,t.clientY);},{passive:true});
    document.addEventListener('touchmove',e=>{const t=e.touches[0]; rMove(t.clientX,t.clientY);},{passive:true});
    document.addEventListener('touchend',rUp);
  })();

  // ===== Events / Init =====
  document.addEventListener('DOMContentLoaded', async ()=>{
    populateDatalistsFromMemory();
    await loadAssignments();
    await unifiedSearch('');
    setInterval(loadAssignments, ASSIGNMENTS_REFRESH_MS);
  });

  searchInput.addEventListener('input', ()=> unifiedSearch(searchInput.value));
  assignButton.addEventListener('click', assignSelectedToKey);
  keyButtons.forEach(btn=> btn.addEventListener('click',()=> playKey(btn.dataset.key)));
  stopButton.addEventListener('click', stopPlayback);
  modalClose.addEventListener('click', closeMediaModal);
  mediaModal.addEventListener('click', (e)=>{ if(e.target===mediaModal) closeMediaModal(); });

  // Keyboard: 1-5 play, Space stop, Esc close
  window.addEventListener('keydown', (e)=>{
    const k=e.key;
    if(/[1-5]/.test(k)){ playKey(Number(k)); }
    else if(k===' '){ e.preventDefault(); stopPlayback(); }
    else if(k==='Escape'){ closeMediaModal(); }
  });
</script>
</body>
</html>

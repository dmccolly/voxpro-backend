<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VoxPro Media Manager</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .header {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.1);
        }
        
        h1 {
            color: #333;
            font-size: 2.5em;
            margin-bottom: 10px;
        }
        
        .stats {
            display: flex;
            gap: 30px;
            margin-top: 20px;
        }
        
        .stat {
            flex: 1;
            text-align: center;
            padding: 15px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 10px;
        }
        
        .stat-value {
            font-size: 2em;
            font-weight: bold;
        }
        
        .stat-label {
            font-size: 0.9em;
            opacity: 0.9;
            margin-top: 5px;
        }
        
        .filters {
            background: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            align-items: center;
        }
        
        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }
        
        label {
            font-size: 0.85em;
            color: #666;
            font-weight: 500;
        }
        
        select, input {
            padding: 8px 12px;
            border: 2px solid #e0e0e0;
            border-radius: 5px;
            font-size: 14px;
            transition: border-color 0.3s;
        }
        
        select:focus, input:focus {
            outline: none;
            border-color: #667eea;
        }
        
        .media-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        
        .media-card {
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
            transition: transform 0.3s, box-shadow 0.3s;
            cursor: pointer;
            position: relative;
        }
        
        .media-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 40px rgba(0,0,0,0.15);
        }
        
        .media-preview {
            height: 200px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            overflow: hidden;
        }
        
        .media-preview video {
            width: 100%;
            height: 100%;
            object-fit: cover;
            pointer-events: none;
        }
        
        .media-preview audio {
            width: 90%;
            pointer-events: none;
        }
        
        .media-icon {
            font-size: 48px;
            color: white;
        }
        
        .media-content {
            padding: 20px;
        }
        
        .media-title {
            font-size: 1.1em;
            font-weight: 600;
            color: #333;
            margin-bottom: 8px;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }
        
        .media-description {
            color: #666;
            font-size: 0.9em;
            margin-bottom: 12px;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }
        
        .media-meta {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid #eee;
        }
        
        .meta-item {
            font-size: 0.85em;
            color: #888;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 15px;
            font-size: 0.75em;
            font-weight: 500;
            text-transform: uppercase;
        }
        
        .badge-video { background: #e3f2fd; color: #1976d2; }
        .badge-audio { background: #fce4ec; color: #c2185b; }
        .badge-photo { background: #f3e5f5; color: #7b1fa2; }
        .badge-other { background: #e8f5e9; color: #388e3c; }
        
        .badge-approved { background: #4caf50; color: white; }
        .badge-pending { background: #ff9800; color: white; }
        
        .loading {
            text-align: center;
            padding: 60px;
            color: white;
            font-size: 1.2em;
        }
        
        .error {
            background: #fff;
            border-left: 4px solid #f44336;
            padding: 20px;
            margin: 20px 0;
            border-radius: 5px;
            color: #f44336;
        }
        
        .empty-state {
            text-align: center;
            padding: 60px;
            background: white;
            border-radius: 10px;
            color: #666;
        }
        
        .empty-state-icon {
            font-size: 64px;
            margin-bottom: 20px;
            opacity: 0.3;
        }

        /* Modal styles for media detail view */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.8);
            animation: fadeIn 0.3s;
        }

        .modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 15px;
            max-width: 90%;
            max-height: 90%;
            overflow: auto;
            position: relative;
            animation: slideIn 0.3s;
        }

        .modal-close {
            position: absolute;
            top: 15px;
            right: 20px;
            font-size: 30px;
            font-weight: bold;
            color: #aaa;
            cursor: pointer;
            transition: color 0.3s;
        }

        .modal-close:hover {
            color: #000;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes slideIn {
            from { transform: translateY(-50px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>📻 VoxPro Media Manager</h1>
            <p style="color: #666; margin-top: 5px;">Manage and review all submitted media content</p>
            
            <div class="stats">
                <div class="stat">
                    <div class="stat-value" id="totalCount">0</div>
                    <div class="stat-label">Total Media</div>
                </div>
                <div class="stat">
                    <div class="stat-value" id="videoCount">0</div>
                    <div class="stat-label">Videos</div>
                </div>
                <div class="stat">
                    <div class="stat-value" id="audioCount">0</div>
                    <div class="stat-label">Audio Files</div>
                </div>
                <div class="stat">
                    <div class="stat-value" id="pendingCount">0</div>
                    <div class="stat-label">Pending Review</div>
                </div>
            </div>
        </div>
        
        <div class="filters">
            <div class="filter-group">
                <label>Category</label>
                <select id="categoryFilter">
                    <option value="">All Categories</option>
                    <option value="Video">Video</option>
                    <option value="Audio">Audio</option>
                    <option value="Photo">Photo</option>
                    <option value="Other">Other</option>
                </select>
            </div>
            
            <div class="filter-group">
                <label>Status</label>
                <select id="statusFilter">
                    <option value="">All Status</option>
                    <option value="approved">Approved</option>
                    <option value="pending">Pending</option>
                </select>
            </div>
            
            <div class="filter-group">
                <label>Station</label>
                <select id="stationFilter">
                    <option value="">All Stations</option>
                    <option value="KIVI">KIVI</option>
                    <option value="KBOI">KBOI</option>
                </select>
            </div>
            
            <div class="filter-group">
                <label>Search</label>
                <input type="text" id="searchFilter" placeholder="Search title or description...">
            </div>
        </div>
        
        <div id="mediaContainer">
            <div class="loading">⏳ Loading media...</div>
        </div>
    </div>

    <!-- Modal for media details -->
    <div id="mediaModal" class="modal">
        <div class="modal-content">
            <span class="modal-close">&times;</span>
            <div id="modalBody"></div>
        </div>
    </div>
    
    <script>
        let allMedia = [];
        
        // Format file size
        function formatFileSize(bytes) {
            if (!bytes) return 'N/A';
            const sizes = ['B', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(1024));
            return Math.round(bytes / Math.pow(1024, i) * 100) / 100 + ' ' + sizes[i];
        }
        
        // Format date
        function formatDate(timestamp) {
            if (!timestamp) return 'Unknown';
            return new Date(timestamp).toLocaleDateString('en-US', {
                month: 'short',
                day: 'numeric',
                year: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
        }
        
        // Get media icon
        function getMediaIcon(category) {
            switch(category?.toLowerCase()) {
                case 'video': return '🎬';
                case 'audio': return '🎵';
                case 'photo': return '🖼️';
                default: return '📁';
            }
        }
        
        // Create media preview
        function createMediaPreview(item) {
            if (item.media_url) {
                if (item.category === 'Video') {
                    return `<video controls preload="metadata">
                        <source src="${item.media_url}" type="${item.file_type || 'video/mp4'}">
                    </video>`;
                } else if (item.category === 'Audio') {
                    return `<audio controls>
                        <source src="${item.media_url}" type="${item.file_type || 'audio/mpeg'}">
                    </audio>`;
                } else if (item.category === 'Photo') {
                    return `<img src="${item.media_url}" alt="${item.title}" style="width: 100%; height: 100%; object-fit: cover;">`;
                }
            }
            return `<div class="media-icon">${getMediaIcon(item.category)}</div>`;
        }
        
        // View media details - FIXED VERSION
        window.viewMedia = function(id) {
            console.log('Viewing media ID:', id);
            const item = allMedia.find(m => m.id === id);
            
            if (!item) {
                alert('Media not found');
                return;
            }
            
            const modal = document.getElementById('mediaModal');
            const modalBody = document.getElementById('modalBody');
            
            // Create detailed view
            let mediaContent = '';
            if (item.media_url) {
                if (item.category === 'Video') {
                    mediaContent = `
                        <video controls style="width: 100%; max-height: 400px;">
                            <source src="${item.media_url}" type="${item.file_type || 'video/mp4'}">
                            Your browser does not support the video tag.
                        </video>`;
                } else if (item.category === 'Audio') {
                    mediaContent = `
                        <audio controls style="width: 100%; margin: 20px 0;">
                            <source src="${item.media_url}" type="${item.file_type || 'audio/mpeg'}">
                            Your browser does not support the audio tag.
                        </audio>`;
                } else if (item.category === 'Photo') {
                    mediaContent = `<img src="${item.media_url}" alt="${item.title}" style="width: 100%; max-height: 500px; object-fit: contain;">`;
                }
            }
            
            modalBody.innerHTML = `
                <h2>${item.title || 'Untitled Media'}</h2>
                <p style="color: #666; margin: 10px 0;">${item.description || 'No description'}</p>
                
                ${mediaContent}
                
                <div style="margin-top: 20px; padding-top: 20px; border-top: 1px solid #eee;">
                    <h3>Details</h3>
                    <table style="width: 100%; margin-top: 10px;">
                        <tr><td style="padding: 5px; font-weight: bold;">ID:</td><td>${item.id}</td></tr>
                        <tr><td style="padding: 5px; font-weight: bold;">Category:</td><td>${item.category || 'N/A'}</td></tr>
                        <tr><td style="padding: 5px; font-weight: bold;">Status:</td><td>${item.is_approved ? 'Approved ✅' : 'Pending Review ⏳'}</td></tr>
                        <tr><td style="padding: 5px; font-weight: bold;">Submitted By:</td><td>${item.submitted_by || 'Anonymous'}</td></tr>
                        <tr><td style="padding: 5px; font-weight: bold;">Station:</td><td>${item.station || 'N/A'}</td></tr>
                        <tr><td style="padding: 5px; font-weight: bold;">Priority:</td><td>${item.priority || 'Normal'}</td></tr>
                        <tr><td style="padding: 5px; font-weight: bold;">File:</td><td>${item.filename || 'N/A'}</td></tr>
                        <tr><td style="padding: 5px; font-weight: bold;">Size:</td><td>${formatFileSize(item.file_size)}</td></tr>
                        <tr><td style="padding: 5px; font-weight: bold;">Created:</td><td>${formatDate(item.created_at)}</td></tr>
                        ${item.tags ? `<tr><td style="padding: 5px; font-weight: bold;">Tags:</td><td>${item.tags}</td></tr>` : ''}
                        ${item.notes ? `<tr><td style="padding: 5px; font-weight: bold;">Notes:</td><td>${item.notes}</td></tr>` : ''}
                    </table>
                </div>
                
                ${item.media_url ? `
                    <div style="margin-top: 20px;">
                        <a href="${item.media_url}" target="_blank" style="display: inline-block; padding: 10px 20px; background: #667eea; color: white; text-decoration: none; border-radius: 5px;">
                            Open in New Tab →
                        </a>
                    </div>
                ` : ''}
            `;
            
            modal.classList.add('active');
        }
        
        // Render media cards - FIXED VERSION with proper event binding
        function renderMedia(media) {
            const container = document.getElementById('mediaContainer');
            
            if (media.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">📭</div>
                        <h2>No media found</h2>
                        <p>Try adjusting your filters or submit some new content!</p>
                    </div>
                `;
                return;
            }
            
            // Create cards with data attributes instead of onclick
            const cards = media.map(item => `
                <div class="media-card" data-media-id="${item.id}">
                    <div class="media-preview">
                        ${createMediaPreview(item)}
                    </div>
                    <div class="media-content">
                        <div class="media-title">
                            ${item.title || 'Untitled Media'}
                        </div>
                        <div class="media-description">
                            ${item.description || 'No description provided'}
                        </div>
                        <div style="display: flex; gap: 8px; margin-bottom: 10px;">
                            <span class="badge badge-${(item.category || 'other').toLowerCase()}">
                                ${item.category || 'Other'}
                            </span>
                            <span class="badge badge-${item.is_approved ? 'approved' : 'pending'}">
                                ${item.is_approved ? 'Approved' : 'Pending'}
                            </span>
                        </div>
                        <div class="media-meta">
                            <span class="meta-item">
                                👤 ${item.submitted_by || 'Anonymous'}
                            </span>
                            <span class="meta-item">
                                📅 ${formatDate(item.created_at)}
                            </span>
                            <span class="meta-item">
                                💾 ${formatFileSize(item.file_size)}
                            </span>
                            ${item.station ? `<span class="meta-item">📡 ${item.station}</span>` : ''}
                        </div>
                    </div>
                </div>
            `).join('');
            
            container.innerHTML = `<div class="media-grid">${cards}</div>`;
            
            // Add click event listeners to all cards
            document.querySelectorAll('.media-card').forEach(card => {
                card.addEventListener('click', function(e) {
                    // Don't trigger if clicking on controls
                    if (e.target.tagName === 'VIDEO' || e.target.tagName === 'AUDIO') {
                        return;
                    }
                    const mediaId = parseInt(this.getAttribute('data-media-id'));
                    viewMedia(mediaId);
                });
            });
        }
        
        // Apply filters
        function applyFilters() {
            const category = document.getElementById('categoryFilter').value;
            const status = document.getElementById('statusFilter').value;
            const station = document.getElementById('stationFilter').value;
            const search = document.getElementById('searchFilter').value.toLowerCase();
            
            let filtered = allMedia;
            
            if (category) {
                filtered = filtered.filter(item => item.category === category);
            }
            
            if (status) {
                filtered = filtered.filter(item => 
                    status === 'approved' ? item.is_approved : !item.is_approved
                );
            }
            
            if (station) {
                filtered = filtered.filter(item => item.station === station);
            }
            
            if (search) {
                filtered = filtered.filter(item => 
                    (item.title || '').toLowerCase().includes(search) ||
                    (item.description || '').toLowerCase().includes(search) ||
                    (item.submitted_by || '').toLowerCase().includes(search) ||
                    (item.tags || '').toLowerCase().includes(search)
                );
            }
            
            renderMedia(filtered);
        }
        
        // Update statistics
        function updateStats() {
            document.getElementById('totalCount').textContent = allMedia.length;
            document.getElementById('videoCount').textContent = 
                allMedia.filter(m => m.category === 'Video').length;
            document.getElementById('audioCount').textContent = 
                allMedia.filter(m => m.category === 'Audio').length;
            document.getElementById('pendingCount').textContent = 
                allMedia.filter(m => !m.is_approved).length;
        }
        
        // Load media from API
        async function loadMedia() {
            try {
                const response = await fetch('/.netlify/functions/list-media');
                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                
                allMedia = await response.json();
                
                // Sort by newest first
                allMedia.sort((a, b) => b.created_at - a.created_at);
                
                updateStats();
                renderMedia(allMedia);
            } catch (error) {
                console.error('Error loading media:', error);
                document.getElementById('mediaContainer').innerHTML = `
                    <div class="error">
                        <h3>⚠️ Error loading media</h3>
                        <p>${error.message}</p>
                        <p style="margin-top: 10px;">
                            <button onclick="location.reload()" style="padding: 10px 20px; background: #667eea; color: white; border: none; border-radius: 5px; cursor: pointer;">
                                Retry
                            </button>
                        </p>
                    </div>
                `;
            }
        }
        
        // Set up event listeners
        document.getElementById('categoryFilter').addEventListener('change', applyFilters);
        document.getElementById('statusFilter').addEventListener('change', applyFilters);
        document.getElementById('stationFilter').addEventListener('change', applyFilters);
        document.getElementById('searchFilter').addEventListener('input', applyFilters);
        
        // Modal close functionality
        document.querySelector('.modal-close').addEventListener('click', function() {
            document.getElementById('mediaModal').classList.remove('active');
        });
        
        // Close modal when clicking outside
        document.getElementById('mediaModal').addEventListener('click', function(e) {
            if (e.target === this) {
                this.classList.remove('active');
            }
        });
        
        // ESC key to close modal
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                document.getElementById('mediaModal').classList.remove('active');
            }
        });
        
        // Load media on page load
        loadMedia();
        
        // Refresh every 30 seconds
        setInterval(loadMedia, 30000);
    </script>
</body>
</html>
